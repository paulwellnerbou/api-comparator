<% const passed = it.result.differences.length === 0; %>
<% const passedWithErrors = passed && (it.result.reference.statusCode >= 400 || it.result.target.statusCode >= 400); %>
<% const method = it.result.method || 'GET'; %>
<% const displayUrl = it.result.url.replace('{{baseUrl}}', ''); %>
<% const hasSpecificUrls = it.result.referenceUrl && it.result.targetUrl; %>
<% const urlsDiffer = hasSpecificUrls && it.result.referenceUrl !== it.result.targetUrl; %>
<% const displayReferenceUrl = it.result.referenceUrl ? it.result.referenceUrl.replace('{{baseUrl}}', '') : ''; %>
<% const displayTargetUrl = it.result.targetUrl ? it.result.targetUrl.replace('{{baseUrl}}', '') : ''; %>
<% const fullDisplayUrl = displayUrl; %>

<div class="result-item <%= passed ? 'passed' : 'failed' %> <%= passedWithErrors ? 'passed-with-errors' : '' %>" id="result-<%= it.index %>">
  <div class="result-header" onclick="toggleResult(<%= it.index %>)">
    <span class="result-status"><%= passed ? '✅' : '❌' %></span>
    <div class="result-content">
      <div class="result-name">
        <span class="result-method method-<%= method %>"><%= method %></span>
        <% if (urlsDiffer) { %>
          <div class="url-selectable" style="display: flex; flex-direction: column; gap: 0.25rem;">
            <span class="url-text"><span style="font-weight: 400; min-width: 75px; display: inline-block; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;">Reference:</span><%= displayReferenceUrl %></span>
            <span class="url-text"><span style="font-weight: 400; min-width: 75px; display: inline-block; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;">Target:</span><%= displayTargetUrl %></span>
          </div>
        <% } else if (hasSpecificUrls) { %>
          <span class="url-text url-selectable"><%= displayReferenceUrl %></span>
        <% } else { %>
          <span class="url-text url-selectable"><%= displayUrl %></span>
        <% } %>
      </div>
      <div class="result-timing">
        <span>Reference: <strong class="<%= (it.result.reference.statusCode === 0 || it.result.reference.statusCode >= 400) ? 'status-code-error' : 'status-code-ok' %>"><%= it.result.reference.statusCode %> <%= it.result.reference.statusText %></strong> / <%= it.result.reference.duration.toFixed(0) %>ms</span>
        <span>Target: <strong class="<%= (it.result.target.statusCode === 0 || it.result.target.statusCode >= 400) ? 'status-code-error' : 'status-code-ok' %>"><%= it.result.target.statusCode %> <%= it.result.target.statusText %></strong> / <%= it.result.target.duration.toFixed(0) %>ms</span>
      </div>
    </div>
  </div>
  
  <div class="result-details">
    <div class="result-details-content">
      
      <%
      // Build full URLs
      const refUrl = it.result.referenceUrl 
        ? it.result.referenceBaseUrl + it.result.referenceUrl.replace('{{baseUrl}}', '')
        : it.result.referenceBaseUrl + it.result.url.replace('{{baseUrl}}', '');
      const targetUrl = it.result.targetUrl
        ? it.result.targetBaseUrl + it.result.targetUrl.replace('{{baseUrl}}', '')
        : it.result.targetBaseUrl + it.result.url.replace('{{baseUrl}}', '');
      
      // Build curl commands
      function buildCurlCommand(url, method, headers, body) {
        let curl = `curl -X ${method} '${url}'`;
        if (headers && Object.keys(headers).length > 0) {
          for (const [key, value] of Object.entries(headers)) {
            curl += ` \\\n  -H '${key}: ${value}'`;
          }
        }
        if (body && method !== 'GET' && method !== 'HEAD') {
          const bodyStr = typeof body === 'object' ? JSON.stringify(body) : String(body);
          curl += ` \\\n  -d '${bodyStr.replace(/'/g, "'\\''")}'`;
        }
        return curl;
      }
      
      const refCurl = buildCurlCommand(refUrl, method, it.result.referenceRequestHeaders, it.result.requestBody);
      const targetCurl = buildCurlCommand(targetUrl, method, it.result.targetRequestHeaders, it.result.requestBody);
      %>
      
      <div class="request-details">
        <div class="request-details-side">
          <div class="request-details-header">
            <span class="request-details-title">Reference Request</span>
            <button class="copy-curl-btn" onclick="copyCurlCommand(event, 'ref-<%= it.index %>')" title="Copy as cURL">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
              Copy cURL
            </button>
            <textarea id="curl-ref-<%= it.index %>" style="display: none;"><%= refCurl %></textarea>
          </div>
          <div class="request-detail-item">
            <div class="request-detail-label">URL:</div>
            <code class="request-detail-value"><%= refUrl %></code>
          </div>
          <% if (it.result.referenceRequestHeaders && Object.keys(it.result.referenceRequestHeaders).length > 0) { %>
          <div class="request-detail-item">
            <div class="request-detail-label">Headers:</div>
            <code class="request-detail-value request-headers"><%
              const headerEntries = Object.entries(it.result.referenceRequestHeaders);
              for (let i = 0; i < headerEntries.length; i++) {
                const [key, value] = headerEntries[i];
                if (i > 0) { %><%= '\n' %><% }
                %><%= key %>: <%= value %><%
              }
            %></code>
          </div>
          <% } %>
          
          <% if (it.result.requestBody) { %>
          <div class="request-detail-item">
            <div class="request-detail-label">Body:</div>
            <code class="request-detail-value request-body"><%= typeof it.result.requestBody === 'string' ? it.result.requestBody : JSON.stringify(it.result.requestBody, null, 2) %></code>
          </div>
          <% } %>
        </div>
        
        <div class="request-details-side">
          <div class="request-details-header">
            <span class="request-details-title">Target Request</span>
            <button class="copy-curl-btn" onclick="copyCurlCommand(event, 'target-<%= it.index %>')" title="Copy as cURL">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
              Copy cURL
            </button>
            <textarea id="curl-target-<%= it.index %>" style="display: none;"><%= targetCurl %></textarea>
          </div>
          <div class="request-detail-item">
            <div class="request-detail-label">URL:</div>
            <code class="request-detail-value"><%= targetUrl %></code>
          </div>
          <% if (it.result.targetRequestHeaders && Object.keys(it.result.targetRequestHeaders).length > 0) { %>
          <div class="request-detail-item">
            <div class="request-detail-label">Headers:</div>
            <code class="request-detail-value request-headers"><%
              const targetHeaderEntries = Object.entries(it.result.targetRequestHeaders);
              for (let i = 0; i < targetHeaderEntries.length; i++) {
                const [key, value] = targetHeaderEntries[i];
                if (i > 0) { %><%= '\n' %><% }
                %><%= key %>: <%= value %><%
              }
            %></code>
          </div>
          <% } %>
          
          <% if (it.result.requestBody) { %>
          <div class="request-detail-item">
            <div class="request-detail-label">Body:</div>
            <code class="request-detail-value request-body"><%= typeof it.result.requestBody === 'string' ? it.result.requestBody : JSON.stringify(it.result.requestBody, null, 2) %></code>
          </div>
          <% } %>
        </div>
      </div>
      
      <% if (it.result.differences.length > 0) { %>
      <div class="differences">
        <% for (let j = 0; j < it.result.differences.length; j++) { 
          const diff = it.result.differences[j]; %>
          <div class="diff-item">
            <div class="diff-message"><%= diff.message %></div>
            <% if (diff.expected !== undefined && diff.type === 'body' && diff.diffBlocks) { %>
              <div class="diff-view">
                <div class="diff-side">
                  <div class="diff-side-header">Expected (Reference)</div>
                  <div class="diff-content">
                    <code><%
                      for (let blockIdx = 0; blockIdx < diff.diffBlocks.length; blockIdx++) {
                        const block = diff.diffBlocks[blockIdx];
                        if (block.skipped) {
                          if (blockIdx > 0) { %><%= '\n' %><% }
                          %><div class="diff-separator">⋯</div><%
                        } else {
                          for (let k = 0; k < block.lines.length; k++) {
                            const alignedLine = block.lines[k];
                            if (blockIdx > 0 || k > 0) { %><%= '\n' %><% }
                            if (alignedLine.left) {
                              const line = alignedLine.left;
                              const lineNum = line.lineNumber || '';
                              if (line.type === 'removed') { %><span class="diff-line diff-line-removed"><span class="diff-line-number"><%= lineNum %></span><%~ line.content %></span><%
                              } else if (line.type === 'unchanged') { %><span class="diff-line"><span class="diff-line-number"><%= lineNum %></span><%~ line.content %></span><%
                              }
                            } else {
                              // Empty placeholder for added lines
                              %><span class="diff-line diff-line-empty"><span class="diff-line-number"></span> </span><%
                            }
                          }
                        }
                      }
                    %></code>
                  </div>
                </div>
                <div class="diff-side">
                  <div class="diff-side-header">Actual (Target)</div>
                  <div class="diff-content">
                    <code><%
                      for (let blockIdx = 0; blockIdx < diff.diffBlocks.length; blockIdx++) {
                        const block = diff.diffBlocks[blockIdx];
                        if (block.skipped) {
                          if (blockIdx > 0) { %><%= '\n' %><% }
                          %><div class="diff-separator">⋯</div><%
                        } else {
                          for (let k = 0; k < block.lines.length; k++) {
                            const alignedLine = block.lines[k];
                            if (blockIdx > 0 || k > 0) { %><%= '\n' %><% }
                            if (alignedLine.right) {
                              const line = alignedLine.right;
                              const lineNum = line.lineNumber || '';
                              if (line.type === 'added') { %><span class="diff-line diff-line-added"><span class="diff-line-number"><%= lineNum %></span><%~ line.content %></span><%
                              } else if (line.type === 'unchanged') { %><span class="diff-line"><span class="diff-line-number"><%= lineNum %></span><%~ line.content %></span><%
                              }
                            } else {
                              // Empty placeholder for removed lines
                              %><span class="diff-line diff-line-empty"><span class="diff-line-number"></span> </span><%
                            }
                          }
                        }
                      }
                    %></code>
                  </div>
                </div>
              </div>
            <% } else if (diff.expected !== undefined && diff.type === 'body') { %>
              <% 
                const expectedStr = typeof diff.expected === 'object' ? JSON.stringify(diff.expected, null, 2) : String(diff.expected);
                const actualStr = typeof diff.actual === 'object' ? JSON.stringify(diff.actual, null, 2) : String(diff.actual);
              %>
              <div class="diff-view">
                <div class="diff-side">
                  <div class="diff-side-header">Expected (Reference)</div>
                  <div class="diff-content"><code id="diff-expected-<%= it.index %>-<%= j %>"><%= expectedStr %></code></div>
                </div>
                <div class="diff-side">
                  <div class="diff-side-header">Actual (Target)</div>
                  <div class="diff-content"><code id="diff-actual-<%= it.index %>-<%= j %>"><%= actualStr %></code></div>
                </div>
              </div>
            <% } else if (diff.expected !== undefined) { %>
            <div class="diff-values">
              <div class="diff-value">
                <div class="diff-value-label">Expected (Reference)</div>
                <div class="diff-value-content"><%= typeof diff.expected === 'object' ? JSON.stringify(diff.expected, null, 2) : String(diff.expected) %></div>
              </div>
              <div class="diff-value">
                <div class="diff-value-label">Actual (Target)</div>
                <div class="diff-value-content"><%= typeof diff.actual === 'object' ? JSON.stringify(diff.actual, null, 2) : String(diff.actual) %></div>
              </div>
            </div>
            <% } %>
          </div>
        <% } %>
      </div>
    <% } else { %>
      <div class="no-differences">
        <div class="diff-message">✅ No differences</div>
        <% if ((it.result.reference.statusCode === 0 || it.result.reference.statusCode >= 400) && it.result.reference.body !== undefined && it.result.reference.body !== null) { %>
          <div class="diff-view full-width">
            <div class="diff-side">
              <div class="diff-side-header">Response Body</div>
              <div class="diff-content"><code><%= typeof it.result.reference.body === 'object' ? JSON.stringify(it.result.reference.body, null, 2) : String(it.result.reference.body) %></code></div>
            </div>
          </div>
        <% } %>
      </div>
    <% } %>
    
    <% if (it.result.reference.error || it.result.target.error) { %>
    <div class="differences errors-section">
      <div class="detail-title">❌ Errors</div>
      <% if (it.result.reference.error) { %>
        <div class="diff-item">
          <div class="error-subtitle">Reference Error</div>
          <div class="url-display"><%= it.result.reference.error %></div>
        </div>
      <% } %>
      <% if (it.result.target.error) { %>
        <div class="diff-item">
          <div class="error-subtitle">Target Error</div>
          <div class="url-display"><%= it.result.target.error %></div>
        </div>
      <% } %>
    </div>
    <% } %>
    </div>
  </div>
</div>
